apiVersion: batch/v1
kind: Job
metadata:
  name: build-qlever-index
  namespace: qlever
spec:
  template:
    spec:
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 1000
      containers:
      - name: qlever
        image: "adfreiburg/qlever:commit-acb6633"
        workingDir: /index
        resources:
          limits:
            cpu: '4'
            memory: 4G
        command:
          - "sh"
          - "-c"
          - |
            wget -O latest-dump.ttl.gz https://skkg--turtles.s3.eu-central-1.amazonaws.com/latest-dump.ttl.gz && \
            gunzip -f latest-dump.ttl.gz && \
            IndexBuilderMain -F nt -f latest-dump.ttl -i skkg -s /config/skkg.settings.json -m '1 GB' -b '2 MB' -k false
        volumeMounts:
        - mountPath: "/index"
          name: storage
        - name: config-volume
          mountPath: "/config"
          readOnly: true
      restartPolicy: Never
      volumes:
      - name: storage
        persistentVolumeClaim:
          claimName: qlever-index-pvc
      - name: config-volume
        configMap:
          name: skkg-settings
          items:
          - key: "skkg.settings.json"
            path: "skkg.settings.json"
  backoffLimit: 0
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: skkg-settings
  namespace: qlever
data:
  skkg.settings.json: |
    {
      "ascii-prefixes-only": true,
      "num-triples-per-partial-vocab": 500000,
      "num-triples-per-batch": 100000, 
      "parallel-parsing": false 
    }